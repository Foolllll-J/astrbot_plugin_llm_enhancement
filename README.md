<div align="center">

# 🚀 LLM 综合增强

<i>🤖 全方位打造“真人感”AI 群友</i>

![License](https://img.shields.io/badge/license-AGPL--3.0-green?style=flat-square)
![Python](https://img.shields.io/badge/python-3.10+-blue?style=flat-square&logo=python&logoColor=white)
![AstrBot](https://img.shields.io/badge/framework-AstrBot-ff6b6b?style=flat-square)

</div>

## 📖 简介

一款为 [AstrBot](https://astrbot.app) 设计的 LLM 增强插件。通过集成智能唤醒、消息合并、多媒体解析与黑名单管理，并提供可配置的工具权限校验，提升 Bot 在群聊与私聊中的参与感、逻辑连贯性与安全性，让你的 Bot 不再只是被动响应，而是能够“听懂”话题、“看懂”视频、“感知”群成员。

---

## ✨ 功能

本插件通过以下核心模块，将您的 Bot 升级为具备“直觉”与“多维感知”的智能实体：

* **🧠 智能唤醒系统**：支持相关性、活跃期、特定提及、专业答疑等多种触发模式，内置沉默与冷却机制。
* **📦 消息合并增强**：智能聚合短时间内多条消息，支持跨用户上下文合并、撤回消息兜底处理与合并数量上限控制。
* **🎬 媒体文件感知**：支持视频抽帧/ASR、文件引用感知及合并转发内容解析。支持聊天记录视频抽帧上限控制与占位符回退。内置视频总结缓存机制，避免重复解析。
* **🛠️ 增强管理工具**：集成群成员感知、禁言管理、高清头像获取等 LLM 函数工具。
* **🛡️ 黑名单管理器**：支持拉黑/解除拉黑、分页查询与状态查询；可配置是否拦截指令（关闭后仅拦截 LLM 请求）。

---

## 🚀 安装

1. **环境准备**：
   * 系统需安装 FFmpeg 并将其加入环境变量（用于视频/GIF 解析）。
   * 在插件目录执行 `pip install -r requirements.txt` 安装依赖。
2. **插件部署**：
   * 将 `astrbot_plugin_llm_enhancement` 文件夹放入 AstrBot 的 `plugins` 目录。
3. **重启 AstrBot**。

---

## ⚙️ 配置

首次加载后，请在 AstrBot 后台 -> 插件 页面找到本插件进行设置。所有配置项都有详细的说明和提示。

---

## 💡 使用

本插件旨在提供**全自动化**、**无感**的增强体验，以下是各模块详细的功能细节与配置参考：

### 1️⃣ 🧠 智能唤醒：从“被动回复”到“主动参与”

Bot 不再死板地等待艾特，而是根据语境决定是否介入：

* **对话连贯性**：
  * **相关性唤醒**：自动分析当前消息与上下文的关联度。当聊到与上文相关的话题时，它可以主动跟进。
  * **活跃在线期**：Bot 回复后会进入短暂的“兴奋期”，此时用户的后续追问无需艾特即可直接响应。
  * **同用户延长**：可配置唤醒延长仅对“上次触发请求的用户”生效，避免窗口期被其他人消息打断。
  * **模型判定延长**：可选指定一个 Provider 对“是否继续响应”做 T/F 判定；当判定不可用时自动回退本地相似度。
* **特殊信号捕捉**：
  * **专业答疑**：识别群内专业提问或求助信号，精准提供帮助。
  * **昵称提及**：支持配置多个自定义昵称，实现个性化唤醒。
* **情绪与礼节**：
  * **沉默机制**：当用户表示厌烦或进行辱骂时，Bot 会根据配置的阈值自动“闭嘴”一段时间。
  * **空 @ 回复**：当用户空艾特时，插件会自动注入“某某@了你”提示，支持触发消息合并与媒体注入流程。
* **兜底机制**：
  * **主动插嘴**：在以上机制均未触发时，仍有极小概率主动参与聊天，模拟真人的随机性。

### 2️⃣ 📦 消息合并：解决上下文断层

* **自动聚合**：将用户在短时间内发送的多条碎语合并为一条完整请求，节省 Token 并提升理解力。
* **撤回兜底校验**：合并结束后统一校验消息可用性。被撤回/不可获取消息会从本次队列移除；若全部失效则取消请求。
* **数量上限控制**：支持配置单次合并的最大消息条数，避免窗口期无限收集。
* **跨用户合并**：开启后可聚合多人讨论。Bot 会以 `[昵称]: 内容` 的格式清晰分辨发言者，适合处理多人混战。

### 3️⃣ 🎬 理解增强：打破视觉次元壁

* **媒体文件感知**：
  * **多维视频解析**：自动对视频进行抽帧与 ASR 语音转录，让 Bot 既能“看”又能“听”。
  * **高效抽帧**：采用基于视频时长的动态等距抽帧算法，兼顾解析细腻度与 Token 消耗。
  * **文件感知**：当引用包含文件时，自动注入文件名，让 LLM 知晓当前正在讨论的文件对象。
  * **智能屏蔽**：支持分别配置“引用 Bot 自身视频/文件/聊天记录”时的概率拦截，用于忽略用户对非 LLM 消息的回复。
  * **身份注入**：在解析引用消息或转发记录中的多媒体时，自动注入发送者昵称，帮助 LLM 准确分辨“谁发了什么”。
  * **总结缓存**：自动缓存已处理视频的总结内容。当相同视频消息再次被引用时，直接复用缓存结果，提升响应速度并节省 token 消耗。
* **合并转发解析**：
  * **多层级解析**：支持完整读取合并转发记录中的文字内容，即使是多层嵌套的记录也能精准提取。
  * **媒体还原**：同步支持解析记录中的视频关键帧与图片，且可配置视频处理数量与每个视频抽帧上限；任一上限为 0 时仅保留视频占位符。

### 4️⃣ 🛠️ LLM 工具：赋予 Bot 现实行动力

Bot 可根据语境自主调用以下工具函数，无需人工干预：

* **`get_group_members_info`**：获取当前群聊的成员名单（包含昵称与 ID）。
* **`get_user_avatar`**：获取指定用户的 640px 高清头像。
* **`set_group_ban`**：执行禁言或解禁操作，且支持跨会话禁言。
* **`block_user` / `unblock_user`**：拉黑或解除拉黑指定用户。
* **`list_blacklist` / `get_blacklist_status`**：分页查询黑名单与单用户状态。

---

## 🙏 致谢

本插件的开发参考或直接移植了以下优秀项目的部分逻辑，特此鸣谢：

* [astrbot_plugin_wakepro](https://github.com/Zhalslar/astrbot_plugin_wakepro)：提供了智能唤醒参考。
* [astrbot_zssm_explain](https://github.com/xiaoxi68/astrbot_zssm_explain)：提供了视频注入的实现思路。
* [astrbot_plugin_blacklist_tools](https://github.com/ctrlkk/astrbot_plugin_blacklist_tools)：提供了黑名单模块实现参考。

---

## ❤️ 支持

* [AstrBot 帮助文档](https://astrbot.app)
* 如果您在使用中遇到问题，欢迎提交  [Issue](https://github.com/Foolllll-J/astrbot_plugin_llm_enhancement/issues)。

---

<div align="center">

**如果本插件对你有帮助，欢迎点个 ⭐ Star 支持一下！**

</div>
